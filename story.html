<!doctype html>
<html lang="sk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PrÃ­beh â€” vÃ½ber postÃ¡v</title>
  <link rel="stylesheet" href="styles.css" />
</head>

<body>
  <!-- TOP: MBK header (rovnakÃ½ ako ostatnÃ© strÃ¡nky) -->
  <header class="mbk-top">
    <div class="mbk-top__inner">
      <div class="mbk-brand" data-testid="brand">
        <span class="mbk-brand__logo" aria-hidden="true">ğŸ§ª</span>
        <div class="mbk-brand__text">
          <div class="mbk-brand__title">MythBusters Kingdom</div>
          <div class="mbk-brand__subtitle">Playwright UI Playground â€¢ CI/CD ready</div>
        </div>
      </div>

      <div class="mbk-actions">
        <button class="mbk-btn mbk-btn--ghost" data-testid="theme-toggle" type="button">ğŸ¨ Theme</button>
      </div>
    </div>

    <nav class="mbk-navcards" aria-label="NavigÃ¡cia" data-testid="nav">
      <a class="navcard" href="index.html" data-testid="nav-home">
        <div class="navcard__icon" aria-hidden="true">ğŸ </div>
        <div class="navcard__text">
          <div class="navcard__title">Domov</div>
          <div class="navcard__meta">welcome + links</div>
        </div>
      </a>

      <a class="navcard" href="dragon.html" data-testid="nav-dragon">
        <div class="navcard__icon" aria-hidden="true">ğŸ‰</div>
        <div class="navcard__text">
          <div class="navcard__title">Drak</div>
          <div class="navcard__meta">DOM + limit</div>
        </div>
      </a>

      <a class="navcard" href="library.html" data-testid="nav-library">
        <div class="navcard__icon" aria-hidden="true">ğŸ“š</div>
        <div class="navcard__text">
          <div class="navcard__title">KniÅ¾nica</div>
          <div class="navcard__meta">search + select</div>
        </div>
      </a>

      <a class="navcard" href="story.html" data-testid="nav-story">
        <div class="navcard__icon" aria-hidden="true">ğŸ“œ</div>
        <div class="navcard__text">
          <div class="navcard__title">PrÃ­beh</div>
          <div class="navcard__meta">budget + pick</div>
        </div>
      </a>
    </nav>
  </header>

  <!-- PAGE -->
  <main class="mbk-page mbk-page--story" data-testid="page-story">
    <header class="story-head">
      <div class="story-head__title">
        <div class="story-badge" aria-hidden="true">ğŸ“œ</div>
        <div>
          <h1 class="story-h1" data-testid="page-title">PrÃ­beh â€” vÃ½ber postÃ¡v</h1>
          <p class="story-subtitle">
            Vyber postavy do rozprÃ¡vky. KaÅ¾dÃ½ vÃ½ber stojÃ­ body z budgetu. KaÅ¾dÃº postavu vieÅ¡ vybraÅ¥ iba raz.
          </p>
        </div>
      </div>

      <div class="story-toolbar">
        <button class="mbk-btn" type="button" data-testid="btn-reset">Reset</button>
        <button class="mbk-btn mbk-btn--primary" type="button" data-testid="btn-random">Random pick</button>
        <span class="story-pill" data-testid="pill-rules">PravidlÃ¡: 1 klik = 1 vÃ½ber â€¢ bez dvojitÃ©ho kliku</span>
      </div>
    </header>

    <section class="story-grid">
      <!-- Budget panel -->
      <div class="story-panel" data-testid="budget-card">
        <div class="story-panel__hd">
          <h2>Budget</h2>
          <span class="story-pill" data-testid="budget-status">Ready</span>
        </div>

        <div class="story-panel__bd">
          <div class="story-budget-row">
            <div>
              <div class="story-budget-value" data-testid="budget-remaining" aria-live="polite">25</div>
              <div class="story-budget-max">z <span data-testid="budget-total">25</span> bodov</div>
            </div>
            <div class="story-pill" data-testid="budget-spent">
              MinutÃ©: <strong><span data-testid="budget-used">0</span></strong>
            </div>
          </div>

          <div class="story-meter" aria-label="Budget meter">
            <div data-testid="budget-meter"></div>
          </div>

          <div class="story-list">
            <div>
              <div class="story-pill">VybranÃ© postavy</div>
              <div class="story-picked" data-testid="picked-list" aria-live="polite"></div>
              <div class="story-hint" data-testid="picked-empty">ZatiaÄ¾ niÄ. Klikni na kartu postavy vpravo.</div>
            </div>

            <div class="story-hint">
              Tip na testy: vyber postavu a skontroluj budget, potom skÃºs random pick, a nakoniec reset.
            </div>
          </div>
        </div>
      </div>

      <!-- Characters panel -->
      <div class="story-panel" data-testid="characters-panel">
        <div class="story-panel__hd">
          <h2>Postavy</h2>
          <span class="story-pill" data-testid="characters-count">0 vybranÃ½ch</span>
        </div>

        <div class="story-panel__bd">
          <div class="story-cards" data-testid="characters-grid">
            <!-- Cards are rendered by JS -->
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- FOOTER -->
  <footer class="mbk-footer" data-testid="footer">
    <div class="mbk-footer__inner">
      <div>Â© MythBusters Kingdom</div>
      <div class="mbk-footer__links">
        <a href="index.html" data-testid="footer-home">Home</a>
        <a href="dragon.html" data-testid="footer-dragon">Dragon</a>
        <a href="library.html" data-testid="footer-library">Library</a>
        <a href="story.html" data-testid="footer-story">Story</a>
      </div>
    </div>
  </footer>

  <!-- Global toast (shared across pages) - MUST be only once per page -->
  <div class="toast" data-testid="toast" hidden>
    <strong data-testid="toast-title"></strong>
    <p data-testid="toast-msg"></p>
    <button class="mbk-btn mbk-btn--ghost" type="button" data-testid="toast-close">Close</button>
  </div>

  <!-- Shared app behavior (theme, nav active, toast handling, dragon, library...) -->
  <script src="app.js"></script>

  <!-- Story page JS (guarded + test-safe) -->
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const MAX_BUDGET = 25;

      const CHARACTERS = [
        { id: "king", name: "KrÃ¡Ä¾", cost: 6, icon: "ğŸ‘‘", desc: "VlÃ¡dca krÃ¡Ä¾ovstva, mÃ¡ rÃ¡d poriadok a zÃ¡kony." },
        { id: "queen", name: "KrÃ¡Ä¾ovnÃ¡", cost: 6, icon: "ğŸ‘¸", desc: "MÃºdra a prÃ­sna, ale fÃ©rovÃ¡. Vie vyjednÃ¡vaÅ¥." },
        { id: "jester", name: "Å aÅ¡o", cost: 2, icon: "ğŸƒ", desc: "Rozosmeje dvor aj v najhorÅ¡Ã­ deÅˆ." },
        { id: "princess", name: "PrinceznÃ¡", cost: 5, icon: "âœ¨", desc: "OdvÃ¡Å¾na, nenechÃ¡ sa len tak zachrÃ¡niÅ¥." },
        { id: "knight", name: "Rytier", cost: 4, icon: "ğŸ›¡ï¸", desc: "ÄŒesÅ¥, odvaha, a obÄas trochu dramatickÃ½." },
        { id: "wizard", name: "ÄŒarodej", cost: 7, icon: "ğŸ§™", desc: "Vie kÃºzla, ale mÃ¡ svoje pravidlÃ¡." },
        { id: "witch", name: "JeÅ¾ibaba", cost: 5, icon: "ğŸ§¹", desc: "Vie viac, neÅ¾ hovorÃ­. DÃ¡va hÃ¡danky." },
        { id: "dragon3", name: "Drak trojhlavÃ½", cost: 8, icon: "ğŸ²", desc: "Tri hlavy, tri nÃ¡zory, jeden problÃ©m." },
        { id: "dragon7", name: "Drak sedemhlavÃ½", cost: 10, icon: "ğŸ”¥", desc: "Boss level. Bez prÃ­pravy neodporÃºÄame." },
        { id: "wolf", name: "Vlk", cost: 3, icon: "ğŸº", desc: "Ticho, rÃ½chlo a s vlastnou agendou." },
        { id: "giant", name: "Obor", cost: 7, icon: "ğŸ—¿", desc: "VeÄ¾kÃ½, silnÃ½, nie vÅ¾dy najjemnejÅ¡Ã­." },
        { id: "fairy", name: "VÃ­la", cost: 4, icon: "ğŸ§š", desc: "PomÃ¡ha, ale chce, aby si sa nieÄo nauÄila." },
        { id: "thief", name: "Zlodej", cost: 3, icon: "ğŸ§¤", desc: "Vie sa dostaÅ¥ vÅ¡ade. Aj do problÃ©mov." }
      ];

      const state = {
        remaining: MAX_BUDGET,
        selectedIds: new Set()
      };

      // Elements
      const elGrid = document.querySelector('[data-testid="characters-grid"]');
      const elRemaining = document.querySelector('[data-testid="budget-remaining"]');
      const elUsed = document.querySelector('[data-testid="budget-used"]');
      const elTotal = document.querySelector('[data-testid="budget-total"]');
      const elMeter = document.querySelector('[data-testid="budget-meter"]');
      const elPicked = document.querySelector('[data-testid="picked-list"]');
      const elPickedEmpty = document.querySelector('[data-testid="picked-empty"]');
      const elCount = document.querySelector('[data-testid="characters-count"]');
      const btnReset = document.querySelector('[data-testid="btn-reset"]');
      const btnRandom = document.querySelector('[data-testid="btn-random"]');

      // Guard
      const required = [elGrid, elRemaining, elUsed, elTotal, elMeter, elPicked, elPickedEmpty, elCount, btnReset, btnRandom];
      if (required.some(x => !x)) {
        console.warn("Story: required DOM elements missing, script not initialized.");
        return;
      }

      function toast(title, msg, kind = "ok") {
        if (typeof window.showToast === "function") {
          window.showToast(title, msg, kind);
        }
      }

      function updateBudgetUI() {
        const used = MAX_BUDGET - state.remaining;

        elRemaining.textContent = String(state.remaining);
        elUsed.textContent = String(used);
        elTotal.textContent = String(MAX_BUDGET);

        const pct = (used / MAX_BUDGET) * 100;
        elMeter.style.width = pct.toFixed(2) + "%";

        elCount.textContent = `${state.selectedIds.size} vybranÃ½ch`;

        // Picked list
        elPicked.innerHTML = "";
        const selectedChars = CHARACTERS.filter(c => state.selectedIds.has(c.id));

        if (selectedChars.length === 0) {
          elPickedEmpty.style.display = "block";
        } else {
          elPickedEmpty.style.display = "none";
          selectedChars.forEach(c => {
            const tag = document.createElement("span");
            tag.className = "story-tag";
            tag.setAttribute("data-testid", `picked-${c.id}`);
            tag.textContent = `${c.icon} ${c.name} (-${c.cost})`;
            elPicked.appendChild(tag);
          });
        }
      }

      function canPick(character) {
        return !state.selectedIds.has(character.id) && state.remaining >= character.cost;
      }

      function renderCards() {
        elGrid.innerHTML = "";

        CHARACTERS.forEach(character => {
          const card = document.createElement("button");
          card.type = "button";
          card.className = "story-card";
          card.setAttribute("data-testid", `char-${character.id}`);
          card.setAttribute("data-cost", String(character.cost));
          card.setAttribute("aria-pressed", "false");

          const selected = state.selectedIds.has(character.id);
          const insufficient = state.remaining < character.cost;

          if (selected) {
            card.classList.add("is-selected");
            card.disabled = true;
            card.setAttribute("aria-pressed", "true");
            card.setAttribute("data-selected", "true");
          } else if (insufficient) {
            card.classList.add("is-disabled");
            card.disabled = true;
            card.setAttribute("data-disabled-reason", "insufficient-budget");
          }

          // content
          const icon = document.createElement("div");
          icon.className = "story-icon";
          icon.textContent = character.icon;
          icon.setAttribute("aria-hidden", "true");

          const meta = document.createElement("div");
          meta.className = "story-meta";

          const name = document.createElement("p");
          name.className = "story-name";
          name.textContent = character.name;

          const desc = document.createElement("p");
          desc.className = "story-desc";
          desc.textContent = character.desc;

          meta.appendChild(name);
          meta.appendChild(desc);

          const cost = document.createElement("div");
          cost.className = "story-cost";
          cost.setAttribute("data-testid", `cost-${character.id}`);
          cost.textContent = `-${character.cost}`;

          card.appendChild(icon);
          card.appendChild(meta);
          card.appendChild(cost);

          // Click
          card.addEventListener("click", () => {
            if (state.selectedIds.has(character.id)) return;

            if (state.remaining < character.cost) {
              toast("Budget", `NemÃ¡Å¡ budget na "${character.name}" (potrebuje ${character.cost}).`, "warn");
              return;
            }

            state.selectedIds.add(character.id);
            state.remaining -= character.cost;

            updateBudgetUI();
            renderCards();
            toast("VybranÃ©", `PridanÃ¡ postava "${character.name}" (-${character.cost}).`, "ok");
          });

          elGrid.appendChild(card);
        });
      }

      function resetAll() {
        state.remaining = MAX_BUDGET;
        state.selectedIds = new Set();
        updateBudgetUI();
        renderCards();
        toast("Reset", "Reset hotovÃ½.", "ok");
      }

      function randomPick() {
        const candidates = CHARACTERS.filter(c => canPick(c));
        if (candidates.length === 0) {
          toast("Random", "Å½iadna postava sa uÅ¾ nezmestÃ­ do budgetu.", "warn");
          return;
        }

        const pick = candidates[Math.floor(Math.random() * candidates.length)];
        state.selectedIds.add(pick.id);
        state.remaining -= pick.cost;

        updateBudgetUI();
        renderCards();
        toast("Random", `VybranÃ¡ postava "${pick.name}" (-${pick.cost}).`, "ok");
      }

      btnReset.addEventListener("click", resetAll);
      btnRandom.addEventListener("click", randomPick);

      // Init
      updateBudgetUI();
      renderCards();
    });
  </script>
</body>
</html>
